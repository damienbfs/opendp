\documentclass{article}
\input{../../../mod.sty}

\title{\texttt{fn sample\_bernoulli\_exp1}}
\author{Michael Shoemate}

\begin{document}
\maketitle

\contrib
Proves soundness of \texttt{fn sample\_bernoulli\_exp1} in \asOfCommit{mod.rs}{0be3ab3e6}.
This proof is an adaptation of \href{https://arxiv.org/pdf/2004.00010.pdf#subsection.5.1}{subsection 5.1} of \cite{CKS20}.

\section{Vetting history}
\begin{itemize}
    \item \vettingPR{519}
\end{itemize}

\section{Pseudocode}
\subsubsection*{Precondition}
$\texttt{x} \in \mathbb{Q} \cap (0, 1]$

\subsubsection*{Implementation}        
\begin{lstlisting}[language=Python]
def sample_bernoulli_exp1(x) -> bool:
    k = 1
    while True:
        if sample_bernoulli(x / k, false):
            k += 1
        else: 
            return is_odd(k)
\end{lstlisting}

\subsubsection*{Postcondition}
\texttt{sample\_bernoulli\_exp1} returns a boolean sample from $Bernoulli(exp(-x))$, or an error propagated from \texttt{sample\_bernoulli}.

\section{Proof}

Define the random variable $K^{*}$ to be the number of consecutive $i$, starting from one, for which $B_i \sim Bernoulli(x/i)$ is $\top$.

\begin{lemma}
\label{P_K_gt_n}
$P[K^{*} > n] = \frac{x^n}{n!}$ for any integer $n > 0$ \cite{CKS20}.
\end{lemma}

\begin{proof}
Let $A_i \sim Bernoulli(x/i)$ be the sequence of booleans returned from \texttt{sample\_bernoulli}.

\begin{align*}
    P[K^{*} > n] &= P[A_1 = A_2 = ... = A_n = \top] && \text{Since } K^{*} > n, \forall i \leq n, A_i = \top \\
    &= \prod_{k=1}^n P[A_k = \top] && \text{All $A_i$ are independent.} \\
    &= \prod_{k=1}^n \frac{x}{k} && \text{Since $A_k \sim Bernoulli(x/k)$} \\
    &= \frac{x^n}{n!}
\end{align*}
\end{proof}

\begin{theorem}
\label{is_odd_K}
$is\_odd(K^{*}) \sim Bernoulli(exp(-x))$ \cite{CKS20}.
\end{theorem}

\begin{proof}
\begin{align*}
P[K^{*} \text{ odd}] &= \sum_{k=0}^\infty P[K^{*} = 2k + 1] \\
&= \sum_{k=0}^\infty (P[K^{*} > 2k] - P[K^{*} > 2k + 1]) \\
&= \sum_{k=0}^\infty \left(\frac{x^{2k}}{(2k)!} - \frac{x^{2k + 1}}{(2k + 1)!}\right) && \text{by } \ref{P_K_gt_n} \\
&= exp(-x)
\end{align*}

\end{proof}

Conditioned on meeting the preconditions, and not returning an error, 
since $\mathtt{k}$ is distributed according to $K^{*}$, then by \ref{is_odd_K}, 
the return value of $\mathtt{sample\_bernoulli\_exp1(x)}$ is distributed $Bernoulli(exp(-x))$.

\bibliographystyle{alpha}
\bibliography{mod}
\end{document}