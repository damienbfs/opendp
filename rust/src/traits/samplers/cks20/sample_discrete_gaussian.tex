\documentclass{article}
\input{../../../mod.sty}

\title{\texttt{fn sample\_discrete\_gaussian}}
\author{Michael Shoemate}

\begin{document}
\maketitle

\contrib
Proves soundness of \texttt{fn sample\_discrete\_gaussian} in \asOfCommit{mod.rs}{0be3ab3e6}.
This proof is an adaptation of \href{https://arxiv.org/pdf/2004.00010.pdf#subsection.5.3}{subsection 5.3} of \cite{CKS20}.

\section{Vetting history}
\begin{itemize}
    \item \vettingPR{519}
\end{itemize}

\section{Pseudocode}
\subsubsection*{Precondition}
$\texttt{scale} \in \mathbb{Q} \land \texttt{scale} \geq 0$

\subsubsection*{Implementation}        
\begin{lstlisting}[language=Python]
def sample_discrete_gaussian(scale) -> int:
    if scale == 0:
        return 0
    
    t = floor(scale) + 1
    sigma2 = scale**2
    
    while True:
        candidate = sample_discrete_laplace(t)
        x = abs(candidate) - sigma2 / t
        bias = x**2 / (2 * sigma2)
        if sample_bernoulli_exp(bias):
            return candidate
\end{lstlisting}

\subsubsection*{Postcondition}
\texttt{sample\_discrete\_gaussian} returns an integer sample from $\mathcal{N}_\mathbb{Z}(0, scale^2)$, or an error propagated from \texttt{sample\_discrete\_laplace} or \texttt{sample\_bernoulli\_exp}.

\section{Proof}

First, define the target distribution.

\begin{definition}
    (Discrete Gaussian). Let $\mu, \sigma \in \mathbb{R}$ with $\sigma > 0$. 
    The discrete gaussian distribution with location $\mu$ and scale $\sigma$ is denoted $\mathcal{N}_\mathbb{Z}(\mu, \sigma^2)$. 
    It is a probability distribution supported on the integers and defined by \cite{CKS20}
\begin{equation*}
    \forall x \in \mathbb{Z} \quad  P[X = x] = \frac{e^{-\frac{(x - \mu)^2}{2\sigma^2}}}{\sum_{y\in\mathbb{Z}}e^{-\frac{(y - \mu)^2}{2\sigma^2}}} \quad \text{where } X \sim \mathcal{N}_\mathbb{Z}(\mu, \sigma^2)
\end{equation*}
\end{definition}


We must show that the return value of \texttt{sample\_discrete\_gaussian(scale)}, conditioned on not returning an error, is a sample from $\mathcal{N}_\mathbb{Z}(0, scale^2)$.

Let $t = \lfloor \sigma \rfloor + 1$. 
Now fix any iteration of the loop. 

\begin{lemma}
If $y$ is a realization of $Y \sim \mathcal{L}_\mathbb{Z}(0, \sigma)$, and $c$ is a realization of $C \sim Bernoulli(exp(-(|y| - \sigma^2 / t)^2 / (2 \sigma^2)))$, then
$E[C] = \frac{1 - e^{-1/\sigma}}{1 + e^{-1/\sigma}}e^{-\frac{\sigma^2}{2t^2}} \sum_{y\in \mathbb{Z}} e^{-\frac{y^2}{2\sigma^2}}$\cite{CKS20}.
\end{lemma}

\begin{proof}
\begin{align*}
    E[C] &= E[E[C|Y]] \\
    &= E[e^{-\frac{(|Y| - \sigma^2/t)^2}{2\sigma^2}}] && \text{since } E[Bernoulli(p)] = p \\
    &= \frac{1 - e^{-1/\sigma}}{1 + e^{-1/\sigma}} \sum_{y\in \mathbb{Z}} e^{-\frac{(|y| - \sigma^2/t)^2}{2\sigma^2} - |y|/t} && \text{expectation over } Y \sim \mathcal{L}_\mathcal{Z}(0, \sigma) \\
    &= \frac{1 - e^{-1/\sigma}}{1 + e^{-1/\sigma}}e^{-\frac{\sigma^2}{2t^2}} \sum_{y\in \mathbb{Z}} e^{-\frac{y^2}{2\sigma^2}}
\end{align*}
\end{proof}

% We now show that conditioning $Y$ on the success of C gives the desired output distribution.
\begin{theorem}
\label{P_Yy_CT} If $y$ is a realization of $Y \sim \mathcal{L}_\mathbb{Z}(0, \sigma)$ and $c$ is a realization of $C \sim Bernoulli(exp(-(|y| - \sigma^2 / t)^2 / (2 \sigma^2)))$, then
$P[Y=y | C=\top] = \frac{e^{-\frac{y^2}{2\sigma^2}}}{\sum_{y' \in \mathbb{Z}} e^{-\frac{y'^2}{2\sigma^2}}}$. That is, $Y|_{C=\top} \sim \mathcal{N}_\mathbb{Z}(0, \sigma^2)$ \cite{CKS20}.
\end{theorem}

\begin{proof}

\begin{align*}
    P[Y=y | C=\top] &= \frac{P[C=\top|Y=y]P[Y=y]}{P[C=\top]} && \text{Bayes' Theorem} \\
    &= \frac{e^-\frac{(|y| - \sigma^2/t)^2}{2\sigma^2} \frac{1 - e^{-1/t}}{1 + e^{-1/t}} e^{-|y|/t}}{E[C]} && \text{by definition of } \mathcal{L}_\mathbb{Z}(0, \sigma) \\
    &= \frac{e^-\frac{(|y| - \sigma^2/t)^2}{2\sigma^2} e^{-|y|/t}}{e^{-(\sigma/t)^2/2} \sum_{y' \in \mathbb{Z}} e^{-\frac{y'^2}{2\sigma^2}}} \\
    &= \frac{e^{-\frac{y^2}{2\sigma^2}}}{\sum_{y' \in \mathbb{Z}} e^{-\frac{y'^2}{2\sigma^2}}}
\end{align*}
\end{proof}

Since the function's return value is a draw from $Y \sim \mathcal{L}_\mathbb{Z}(0, scale)$ conditioned on $C = \top$, then by \ref{P_Yy_CT}, the return is distributed $\mathcal{N}_\mathbb{Z}(0, scale^2)$.

\bibliographystyle{alpha}
\bibliography{mod}

\end{document}