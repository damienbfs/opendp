\documentclass{article}
\input{../../lib.sty}

% \externaldocument[trans_mod:]{../mod}
% \ref{trans_mod:thrm:privacy-proof}

\title{\texttt{fn make\_quantile\_score\_candidates}}
\author{Michael Shoemate \and Christian Covington \and Ira Globus-Harrus}
\begin{document}
\maketitle  


\contrib

Proves soundness of \rustdoc{transformations/fn}{make\_quantile\_score\_candidates} 
in \asOfCommit{mod.rs}{f5bb719}.
\texttt{make\_quantile\_score\_candidates} returns a Transformation that 
takes a numeric vector database and a vector of numeric quantile candidates,
and returns a vector of scores, where higher scores correspond to more accurate candidates.

\subsection*{Vetting History}
\begin{itemize}
    \item \vettingPR{456}
\end{itemize}

\section{Intuition}
The quantile score function scores each $c$ in a set of candidates $C$.

\begin{equation}
\begin{array}{rl}
    s_i &= -|(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)|
\end{array}
\end{equation}

Where $\#(X < C_i) = |\{x \in X | x < C_i\}|$ is the number of values in $X$ less than $C_i$, 
and similarly for other variations of inequalities.
The scalar score function can be equivalently stated:
\begin{align}
    s_i &= -|(1 - \alpha) \#(X < c) - \alpha \#(X > c)| \\
    &= -|(1 - \alpha) \#(X < c) - \alpha * (|X| - \#(X < c) - \#(X = c))| \\
    &= -|\#(X < c) - \alpha * (|X| - \#(X = c))|
\end{align}

It has an intuitive interpretation as $-|candidate\_rank - ideal\_rank|$, 
where the absolute distance between the candidate and ideal rank penalizes the score.
The ideal rank does not include values in the dataset equal to the candidate.
The score is maximized at zero when the candidate rank is equivalent to the rank at the ideal $\alpha$-quantile.

The scalar scorer is almost equivalent to Smith's\cite{Smith11}, but adjusts for a source of bias when there are values in the dataset equal to the candidate.
For comparison, we can equivalently write the OpenDP scorer as if there were some $\alpha$-discount on dataset entries equal to the candidate.

\[
\begin{array}{cl}
    OpenDP &-|\#(X < c) + \alpha \#(X = c) - \alpha * |X|| \\
    Smith &-|\#(X < c) + 1 \#(X = c) - \alpha * |X||
\end{array}
\]

Observing that $\#(X \leq c) = \#(X < c) + 1 \#(X = c)$.


\subsection{Examples}

Let $X = \{0,1,2,3,4\}$ and $\alpha = 0.5$ (median):

\begin{align*}
    score(X, 0, \alpha) = -|0 - .5 * (5 - 1)| = -2 \\
    score(X, 1, \alpha) = -|1 - .5 * (5 - 1)| = -1 \\
    score(X, 2, \alpha) = -|2 - .5 * (5 - 1)| = -0 \\
    score(X, 3, \alpha) = -|3 - .5 * (5 - 1)| = -1 \\
    score(X, 4, \alpha) = -|4 - .5 * (5 - 1)| = -2
\end{align*}

The score is maximized by the candidate at the true median.

Let $X = \{0,1,2,3,4,5\}$ and $\alpha = 0.5$ (median):

\begin{align*}
    score(X, 0, \alpha) = -|0 - .5 * (6 - 1)| = -2.5 \\
    score(X, 1, \alpha) = -|1 - .5 * (6 - 1)| = -1.5 \\
    score(X, 2, \alpha) = -|2 - .5 * (6 - 1)| = -0.5 \\
    score(X, 3, \alpha) = -|3 - .5 * (6 - 1)| = -0.5 \\
    score(X, 4, \alpha) = -|4 - .5 * (6 - 1)| = -1.5 \\
    score(X, 5, \alpha) = -|5 - .5 * (6 - 1)| = -2.5
\end{align*}

The two candidates nearest the median are scored equally and highest.

Let $X = \{0,1,2,3,4\}$ and $\alpha = 0.25$ (first quartile):

\begin{align*}
    score(X, 0, \alpha) = -|0 - .25 * (5 - 1)| = -1 \\
    score(X, 1, \alpha) = -|1 - .25 * (5 - 1)| = -0 \\
    score(X, 2, \alpha) = -|2 - .25 * (5 - 1)| = -1 \\
    score(X, 3, \alpha) = -|3 - .25 * (5 - 1)| = -2 \\
    score(X, 4, \alpha) = -|4 - .25 * (5 - 1)| = -3
\end{align*}

As expected, the score is maximized when $c = 1$.

Let $X = \{0,1,2,3,4,5\}$ and $\alpha = 0.25$ (first quartile):

\begin{align*}
    score(X, 0, \alpha) = -|0 - .25 * (6 - 1)| = -1.25 \\
    score(X, 1, \alpha) = -|1 - .25 * (6 - 1)| = -0.25 \\
    score(X, 2, \alpha) = -|2 - .25 * (6 - 1)| = -0.75 \\
    score(X, 3, \alpha) = -|3 - .25 * (6 - 1)| = -1.75 \\
    score(X, 4, \alpha) = -|4 - .25 * (6 - 1)| = -2.75 \\
    score(X, 5, \alpha) = -|5 - .25 * (6 - 1)| = -3.75
\end{align*}

The ideal rank is 1.25. The nearest candidate, 1, has the greatest score, followed by 2, and then 0. 


\section{Hoare Triple}
\subsection*{Precondition}
\begin{itemize}
    \item \texttt{TIA} (input atom type) is a type with trait \rustdoc{traits/trait}{Number}.
    \item \texttt{TOA} (output atom type) is a type with trait \rustdoc{traits/trait}{Float}.
\end{itemize}


\subsection*{Function}
\label{sec:python-pseudocode}
\lstinputlisting[language=Python,firstline=2]{./pseudocode/make_quantile_score_candidates.py}


\subsection*{Postcondition}
\validTransformation{(\texttt{candidates}, \texttt{alpha})}{\texttt{make\_quantile\_score\_candidates}}

\section{Proof}
\subsection{Appropriate Output Domain}
\label{sec:approp-output-domain}
The raw type and domain are equivalent, save for potential nullity in the atomic type. 
The scalar scorer structurally cannot emit null, because the input argument is non-null.

\subsection{Domain-metric compatibility}
On the input side, SymmetricDistance is well-defined on VectorDomains. 
On the output side, InfDifferenceDistance is well-defined on VectorDomains.

\subsection{Stability Guarantee}

\begin{lemma}
    \label{single-change-stab}
    If $d_{Sym}(X, X') = 1$, then $d_\infty(\function(X), \function(X')) \le max(\alpha, 1 - \alpha)$.
\end{lemma}

\begin{proof}
Assume $d_{Sym}(X, X') = 1$. 
For convenience, let $s = \function(X)$.
Consider each of the three cases of adding or removing an element in X.

\begin{align*}
    d_\infty(s_i, s'_i) &= \max\limits_{i} |s_i - s'_i| &&\text{by definition of } d_\infty \\
\intertext{Case 1. Assume $X'$ is equal to $X$, but with some $X_j < C_i$ added or removed.}
    &= \max\limits_{s \sim s'} \max\limits_{i} ||(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)| 
        \\&\hspace{1cm} - |(1 - \alpha) (\#(X < C_i) \pm 1) - \alpha \#(X > C_i)|| \\
    &\leq \max\limits_{s \sim s'} \max\limits_{i} ||(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)|
        \\&\hspace{1cm} - (|(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)| + |\pm(1 - \alpha)|)| &&\text{by triangle inequality} \\
    &= \max\limits_{s \sim s'} \max\limits_{i} |1 - \alpha| &&\text{scores cancel}\\
    &= 1 - \alpha &&\text{since } \alpha \leq 1
\intertext{Case 2. Assume $X'$ is equal to $X$, but with some $X_j > C_i$ added or removed.}
    &= \max\limits_{s \sim s'} \max\limits_{i} ||(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)| 
        \\&\hspace{1cm} - |(1 - \alpha) \#(X < C_i) - \alpha (\#(X > C_i) \pm 1)|| \\
    &\leq \max\limits_{s \sim s'} \max\limits_{i} ||(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)| 
        \\&\hspace{1cm} - (|(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)| + |\pm\alpha|)| &&\text{by triangle inequality} \\
    &= \max\limits_{s \sim s'} \max\limits_{i} |\alpha| &&\text{scores cancel}\\
    &= \alpha &&\text{since } \alpha \geq 0
\intertext{Case 3. Assume $X'$ is equal to $X$, but with some $X_j = C_i$ added or removed.}
    &= \max\limits_{s \sim s'} \max\limits_{i} ||(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)| 
        \\&\hspace{1cm} - |(1 - \alpha) \#(X < C_i) - \alpha \#(X > C_i)|| \\
    &= 0 &&\text{no change in score}
\intertext{Take the union bound over all cases.}
    d_\infty(s_i, s'_i) &= max(\alpha, 1 - \alpha)
\end{align*}
\label{unsized-stability}

\end{proof}

Take any two elements $X, X'$ in the \texttt{input\_domain} and any pair $(\din, \dout)$, 
where \din\ has the associated type for \texttt{input\_metric} and \dout\ has the associated type for \texttt{output\_metric}.
Assume $X, X'$ are \din-close under \texttt{input\_metric} and that $\texttt{stability\_map}(\din) \leq \dout$. 

\begin{align*}
    \dout &= \max\limits_{X \sim X'} d_{IDD}(s, s') &&\text{where } s = \function(X)\\
    &= \max\limits_{X \sim X'} \max\limits_{ij} |(s_i - s'_i) - (s_j - s'_j)| &&\text{by definition of }\rustdoc{metrics/struct}{InfDifferenceDistance} \\
    &\leq 2 \max\limits_{X \sim X'} \max\limits_{i} |s_i - s'_i| &&\text{$s$ is not monotonic; take looser bound}\\
    &\leq 2 \sum_j^{\din} \max\limits_{Z_{j} \sim Z_{j+1}} \max\limits_{i} |s_{i,j} - s_{i,j+1}| &&\text{by path property where } d_{Sym}(Z_i, Z_{i+1}) = 1, X = Z_0 \text{ and } Z_\din = X' \\
    &\leq 2 \sum_j^{\din} max(\alpha, 1 - \alpha) &&\text{by \ref{single-change-stab}} \\
    &\leq 2 \cdot \din \\
\end{align*}


It is shown that \function(X), \function(X') are \dout-close under \texttt{output\_metric}.


\bibliographystyle{plain}
\bibliography{references.bib}

\end{document}
